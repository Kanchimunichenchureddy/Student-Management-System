#!/usr/bin/env python3
"""
Database migration script for Student Management System
Run this script to add missing columns to existing tables
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from backend.models import engine

def migrate_database():
    """Add missing columns to existing tables"""
    print("Running database migration...")
    
    try:
        with engine.connect() as conn:
            # Check if created_at column exists in students table
            result = conn.execute(
                text("SHOW COLUMNS FROM students LIKE 'created_at'")
            )
            if not result.fetchone():
                print("Adding created_at column to students table...")
                conn.execute(text("ALTER TABLE students ADD COLUMN created_at DATETIME DEFAULT CURRENT_TIMESTAMP"))
                print("Added created_at column")
            
            # Check if updated_at column exists in students table
            result = conn.execute(
                text("SHOW COLUMNS FROM students LIKE 'updated_at'")
            )
            if not result.fetchone():
                print("Adding updated_at column to students table...")
                conn.execute(text("ALTER TABLE students ADD COLUMN updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
                print("Added updated_at column")
            
            # Check if users table has all required columns
            result = conn.execute(
                text("SHOW COLUMNS FROM users LIKE 'created_at'")
            )
            if not result.fetchone():
                print("Adding created_at column to users table...")
                conn.execute(text("ALTER TABLE users ADD COLUMN created_at DATETIME DEFAULT CURRENT_TIMESTAMP"))
                print("Added created_at column to users")
            
            result = conn.execute(
                text("SHOW COLUMNS FROM users LIKE 'updated_at'")
            )
            if not result.fetchone():
                print("Adding updated_at column to users table...")
                conn.execute(text("ALTER TABLE users ADD COLUMN updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP"))
                print("Added updated_at column to users")
            
            # Check if courses table has instructor_id column
            result = conn.execute(
                text("SHOW COLUMNS FROM courses LIKE 'instructor_id'")
            )
            if not result.fetchone():
                print("Adding instructor_id column to courses table...")
                conn.execute(text("ALTER TABLE courses ADD COLUMN instructor_id INTEGER REFERENCES users(id)"))
                print("Added instructor_id column to courses")
            
            print("\nDatabase migration completed successfully!")
            
    except Exception as e:
        print(f"Error during migration: {e}")
        return False
    
    return True

if __name__ == "__main__":
    from sqlalchemy import text
    success = migrate_database()
    sys.exit(0 if success else 1)
